apiVersion: k8s.mariadb.com/v1alpha1
kind: MariaDB
metadata:
  name: {{ .Release.Name }}-db
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: mariadb
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  rootEmptyPassword: false
  database: {{ .Values.database.name | quote }}
  username: {{ .Values.database.user | quote }}
  
  passwordSecretKeyRef:
    name: {{ .Release.Name }}-secrets
    key: mysql-password
  rootPasswordSecretKeyRef:
    name: {{ .Release.Name }}-secrets
    key: mysql-root-password

  storage:
    size: {{ .Values.persistence.dbSize | default "5Gi" | quote }}
    storageClassName: {{ .Values.persistence.storageClass | default "longhorn" | quote }}
    ephemeral: false

  # Solo configuramos el streaming de logs si PITR est√° activo
  {{- if .Values.backup.pitr.enabled }}
  backup:
    pointInTimeRecovery:
      s3:
        bucket: {{ .Values.backup.bucketBinlogs | quote }}
        endpoint: {{ .Values.backup.s3Endpoint | quote }}
        region: {{ .Values.backup.region | quote }}
        prefix: {{ printf "binlogs/%s/" .Release.Name | quote }}
        secretRef:
          name: "aws-s3-backups"
  {{- end }}

  myCnf: |
    [mariadb]
    {{- if .Values.backup.pitr.enabled }}
    log-bin
    binlog_format=ROW
    expire_logs_days=7
    {{- end }}
    max_binlog_size=100M